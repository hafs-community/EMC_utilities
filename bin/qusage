#! /bin/bash

function usage {
cat<<EOF
This script generates CPU core usage information by a specific user,
account, group, class, queue (qos) or by all users.  

To call it:
  qusage -u username
  qusage username
  qusage -g groupname
  qusage -a            (all users)
  qusage -A account
  qusage -q queuename   (same as qos)
EOF
if [[ "$#" != 0 ]] ; then
    echo "$@"
fi
}

function awkit {
    printf "%20s:  " "$1"
    grep  -E '^ *(Moab.)?[0-9]+[      ]*[A-Za-z.][0-9A-Za-z_.]+[      ]+.*(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec).*' | \
    awk '
      BEGIN{
        r=0; i=0; o=0;
      }
      {
        if($3=="Running") {
          r+=$4
        } else if($3=="Idle") {
          i+=$4
        } else {
          o+=$4
        }
      } END {
        printf "running %5d, queued %5d, other %5d\n",r,i,o
      }
    '
}

function needarg {
    if [[ "$1" -lt 2 ]] ; then
        usage "SCRIPT IS ABORTING: $2 REQUIRES AN ARGUMENT" 1>&2
        exit 2
    fi
}

if [[ "$#" == 0 ]] ; then
    showq -w "user=$USER" | awkit "$USER"
    exit "$?"
fi

while [[ "$#" -gt 0 ]] ; do
    case "$1" in
        -a) showq | awkit "*"  ;                                    shift 1 ;;
        -u) needarg "$#" "$1" ; showq -w "user=$2" | awkit "$2"   ; shift 2 ;; 
        -g) needarg "$#" "$1" ; showq -w "group=$2" | awkit "$2"  ; shift 2 ;;
        -c) needarg "$#" "$1" ; showq -w "class=$2" | awkit "$2"  ; shift 2 ;;
        -q) needarg "$#" "$1" ; showq -w "qos=$2" | awkit "$2"    ; shift 2 ;;
        -p) needarg "$#" "$1" ; showq -w "partition=$2" | awkit "$2"    ; shift 2 ;;
        -A) needarg "$#" "$1" ; showq -w "acct=$2" | awkit "$2"   ; shift 2 ;;
        -h) usage ; exit 0 ;;
        --) shift 1 ; break ;;
        -*) usage "SCRIPT IS ABORTING: INVALID ARGUMENT $1" 1>&2 ; exit 1 ;;
        *) showq -w "user=$1" | awkit "$1" ; shift 1 ;;
    esac
done
